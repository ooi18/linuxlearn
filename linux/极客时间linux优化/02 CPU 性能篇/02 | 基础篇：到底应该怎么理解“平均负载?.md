平均负载
---
系统处于`可运行状态`和 `不可中断状态`的平均进程数,也就是平均活跃进程数.

可运行状态:指的是在 CPU 或者正在等待 CPU的进程,也就是我们ps 看到的 R 状态(Running 或 Runnable) 的进程

不可运行状态: 处于内核态关键流程中的进程,并且这些流程不可以被打断,比如常见的等待硬件设备的I/O响应,也就是我们使用PS 命令看到的D状态(Uninterruptible Sleep,也称为 Disk Sleep) 的进程

> 不可中断状态实际上是系统对进程和硬件设备的一种保护机制


平均进程多少合理
----

理想状态：每个cpu上都有一个活跃进程，即平均负载数等于cpu数

过载经验值：平均负载高于cpu数量70%的时候

平均负载最理想的情况是等于CPU个数,所以在评判平均负载是,首先需要看一下cpu 有几个,可以通过 top 命令或者 从文件 `/proc/cpuinfo` 中读取

    grep -c processor /proc/cpuinfo
    # 或者
    cat /proc/cpuinfo | grep "processor" | wc -l
    # 物理核心数
    grep 'core id' /proc/cpuinfo | sort -u | wc -l


平均负载有三个值,分别为 1分钟,5分钟,15分钟的负载情况,如果差别不大,说明系统比较稳定.如果1分钟的值远小于15分钟的值,说明系统最近1分钟的负载在减少,而过去15分钟内可能有比较大的负载.

反过来想,如果1分钟的值远大于15分钟的值,说明最近1分钟的负载在增加.

平均负载与cpu使用率的区别?
---


CPU 使用率,是单位时间内 CPU 繁忙程度的统计,和平均负载并不一定完全对应.比如

- CPU 密集型进程,使用大量 CPU 会导致平均负载升高,此时这两者是一致的
- I/O 密集型进程,等待 I/O 也会导致负载升高,但是CPU 使用率不一定高
- 大量等待 CPU 的进程调度也会导致平均负载升高,此时的CPU使用率也会比较高



分析案例
----

- stress  Linux 系统压力测试工具
- sysstat 性能查看工具
    - mpstat 是一个常用的多核 CPU 性能分析同居,用来试试查看每个 CPU 的性能指标
    - pidstat 是一个常见的进程分析工具,用来试试查看进程的CPU,内存,I/O以及上下文切换等性能指标

1. cpu 密集型进程

    stress -c 1 --timeout 600
    # -d 参数表示高亮显示变化的区域
    $ watch -d uptime
    ...,  load average: 1.00, 0.75, 0.39
    # 间隔 5 秒后输出一组数据
    $ pidstat -u 5 1
    13:37:07      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    13:37:12        0      2962  100.00    0.00    0.00    0.00  100.00     1  stress


2. I/O 密集型进程

    $ stress -i 1 --timeout 600
    $ watch -d uptime
    ...,  load average: 1.06, 0.58, 0.37
    # 显示所有 CPU 的指标，并在间隔 5 秒输出一组数据
    $ mpstat -P ALL 5 1
    Linux 4.15.0 (ubuntu)     09/22/18     _x86_64_    (2 CPU)
    13:41:28     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    13:41:33     all    0.21    0.00   12.07   32.67    0.00    0.21    0.00    0.00    0.00   54.84
    13:41:33       0    0.43    0.00   23.87   67.53    0.00    0.43    0.00    0.00    0.00    7.74
    13:41:33       1    0.00    0.00    0.81    0.20    0.00    0.00    0.00    0.00    0.00   98.99
    # 间隔 5 秒后输出一组数据，-u 表示 CPU 指标
    $ pidstat -u 5 1
    Linux 4.15.0 (ubuntu)     09/22/18     _x86_64_    (2 CPU)
    13:42:08      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    13:42:13        0       104    0.00    3.39    0.00    0.00    3.39     1  kworker/1:1H
    13:42:13        0       109    0.00    0.40    0.00    0.00    0.40     0  kworker/0:1H
    13:42:13        0      2997    2.00   35.53    0.00    3.99   37.52     1  stress
    13:42:13        0      3057    0.00    0.40    0.00    0.00    0.40     0  pidstat

3. 大量进程场景

    # 模拟 8 个进程
    $ stress -c 8 --timeout 600
    $ uptime
    ...,  load average: 7.97, 5.93, 3.02
    # 间隔 5 秒后输出一组数据
    $ pidstat -u 5 1
    14:23:25      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    14:23:30        0      3190   25.00    0.00    0.00   74.80   25.00     0  stress
    14:23:30        0      3191   25.00    0.00    0.00   75.20   25.00     0  stress
    14:23:30        0      3192   25.00    0.00    0.00   74.80   25.00     1  stress
    14:23:30        0      3193   25.00    0.00    0.00   75.00   25.00     1  stress
    14:23:30        0      3194   24.80    0.00    0.00   74.60   24.80     0  stress
    14:23:30        0      3195   24.80    0.00    0.00   75.00   24.80     0  stress
    14:23:30        0      3196   24.80    0.00    0.00   74.60   24.80     1  stress
    14:23:30        0      3197   24.80    0.00    0.00   74.80   24.80     1  stress
    14:23:30        0      3200    0.00    0.20    0.00    0.20    0.20     0  pidstat
