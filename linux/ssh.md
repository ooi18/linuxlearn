> sh命令是openssh套件中的客户端连接工具，可以给予ssh加密协议实现安全的远程登录服务器。

    选项
    -1：强制使用ssh协议版本1；
    -2：强制使用ssh协议版本2；
    -4：强制使用IPv4地址；
    -6：强制使用IPv6地址；
    -A：开启认证代理连接转发功能；
    -a：关闭认证代理连接转发功能；
    -b：使用本机指定地址作为对应连接的源ip地址；
    -C：请求压缩所有数据；
    -F：指定ssh指令的配置文件；
    -f：后台执行ssh指令；
    -g：允许远程主机连接主机的转发端口；
    -i：指定身份文件；
    -l：指定连接远程服务器登录用户名；
    -N：不执行远程指令；
    -o：指定配置选项；
    -p：指定远程服务器上的端口；
    -q：静默模式；
    -X：开启X11转发功能；
    -x：关闭X11转发功能；
    -y：开启信任X11转发功能。
    

### # ssh 转发


可以将远端服务器一个端口remote_port绑定到本地端口port，其中-C是进行数据压缩，-f是后台操作，
只有当提示用户名密码的时候才转向前台。-N是不执行远端命令，在只是端口转发时这条命令很有用处。-g 是允许远端主机连接本地转发端口。
-R表明是将远端主机端口映射到本地端口。如果是-L，则是将本地端口映射到远端主机端口。


ssh的三个强大的端口转发命令：
```
转发到远端：ssh -C -f -N -g -L 本地端口:目标IP:目标端口 用户名@目标IP

转发到本地：ssh -C -f -N -g –R 本地端口:目标IP:目标端口 用户名@目标IP

ssh -C -f -N -g -D listen_port user@Tunnel_Host

-C：压缩数据传输。

-f ：后台认证用户/密码，通常和-N连用，不用登录到远程主机。

-N ：不执行脚本或命令，通常与-f连用。

-g ：在-L/-R/-D参数中，允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接。

-L 本地端口:目标IP:目标端口

将本地机(客户机)的某个端口转发到远端指定机器的指定端口. 工作原理是这样的, 本地机器上分配了一个 socket 侦听 port 端口, 一旦这个端口上有了连接, 该连接就经过安全通道转发出去, 同时远程主机和 host 的 hostport 端口建立连接. 可以在配置文件中指定端口的转发. 只有 root 才能转发特权端口. IPv6 地址用另一种格式说明: port/host/hostport

-R本地端口:目标IP:目标端口

将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. 工作原理是这样的, 远程主机上分配了一个 socket 侦听 port 端口, 一旦这个端口上有了连接, 该连接就经过安全通道转向出去, 同时本地主机和 host 的 hostport 端口建立连接. 可以在配置文件中指定端口的转发. 只有用 root 登录远程主机才能转发特权端口. IPv6 地址用另一种格式说明: port/host/hostport

-p ：被登录的ssd服务器的sshd服务端口。

-D port

指定一个本地机器 “动态的'’ 应用程序端口转发. 工作原理是这样的, 本地机器上分配了一个 socket 侦听 port 端口, 一旦这个端口上有了连接, 该连接就经过安全通道转发出去, 根据应用程序的协议可以判断出远程主机将和哪里连接. 目前支持 SOCKS4 协议, 将充当 SOCKS4 服务器. 只有 root 才能转发特权端口. 可以在配置文件中指定动态端口的转发.
```
**应用举例**

1.将发往本机的80端口访问转发到 174.139.9.66 的8080端口
````
ssh -C -f -N -g -L 80:174.139.9.66:8080  master@174.139.9.66
````

2.将发往174.139.9.66的 80 访问转发到本机的 8080 端口

````
ssh -C -f -N -g -R 80:localhost:8080  master@174.139.9.66
````

-N 不使用Shell窗口，纯做转发的时候用，如果你在映射完成后继续在服务器上输入命令，去掉这个参数即可

**例子: 我们想远程管理服务器上的MySQL,那么使用下面命令**

```
ssh -L 3307:127.0.0.1:3306 zyl@xx.xx.xx.xx -N
```

运行命令之后,ssh 将会自动将服务器的 3306 映射到本机的3307 端口,我们可以使用任意的 mysql客户端连接

```
mysql -P 3307 -uroot -p
```

**注:** 比如我们的 mysql 限制了root:root 只能127.0.0.1 访问,由于我们设置的是将远程主机的 127.0.0.1:3306 映射到本机的 3307,
这时候我们操作 3307 就相当与本机操作一样

**例子B:一次同时映射多个端口**
```
ssh -L 0.0.0.0:80:xx.xx.xx.xx:8761 0.0.0.0:81:xx.xx.xx.xx:8763  zyl@xx.xx.xx.xx -N
```

将本机的80,81(全部网卡) 分别映射到远程主机的 8761,8763 端口,监听范围

### # 通过SSH隧道建立SOCKS服务器

> xx.xx.xx.xx 为一台可以在外网访问的主机

通过下面的命令我们可以建立一个通过 xx.xx.xx.xx 的SOCKS服务器

```
ssh -N -f -D 1080 123.123.123.123 # 将端口绑定在127.0.0.1上

ssh -N -f -D 0.0.0.0:1080 123.123.123.123 # 将端口绑定在0.0.0.0上
```

通过SSH建立的SOCKS服务器使用的是SOCKS5协议，在为应用程序设置SOCKS代理的时候要特别注意。


例子: ssh 隧道翻墙
```
ssh -N -f -D 7001 root@xx.xx.xx.xx 
## ssh -D  7001 root@xx.xx.xx.xx -N -v
```

参考: http://www.pchou.info/linux/2015/11/01/ssh-tunnel.html

### #1 反向隧道技术

前面我们使用的 -L ,切入点是在运行 `ssh -C -f -N -g -L 本地端口:目标IP:目标端口 用户名@目标IP` 这台机器上面,
也就是我们需要利用这台机器,作为跳板到其他机器上面,但是如果我们想要利用被作为跳板的机器操作这台机器的时候,我们就需要
用到 `反向隧道技术了`

> 情景：节假日需要回公司加班。但是公司是内网，使用NAT，所以没办法连回去。

现在公司机器(LAN_ip)上执行
````
ssh -NfR 2222:localhost:22 home_ip
````

-R : 建立反向连接 将 home_ip port转发

现在，到home_ip上面
````
ssh localhost -p 2222
````
就跑在NAT后面的公司机器。就是后门了。灰鸽子木马用的也是反向链接。

Destination (LAN_ip) <- |NAT| <- Source (home_ip)


### #2 端口转发

情景：本机不允许访问www.xxx.com这个网站，但是远程主机(remote_ip)可以。

````
ssh -f -N -L 31609:www.xxx.com:80 user@remote_ip
````

现在我们就可以在本地打开 http://localhost:31609 访问www.xxx.com了。

### #3 SOCKS代理

情景： 本机不允许访问某些网站，但是远程主机(remote_ip)可以，并且公司没有组织你连接remote_ip。
````
ssh -NfD 8888 user@remote_ip
````

现在在浏览器socks 5 proxy设置为localhost:8888,所有之前无法访问的网站现在都可以访问了。

### # 4 本地端口 ==> 监听全部网卡

```
apt install socat
socat tcp-listen:80,reuseaddr,fork tcp:localhost:1234
```
其中80为linux本机开的对外端口，1234为内网连接传输数据的端口，本条命令的作用是把由ssh转发到本机（外网linux）1234端口的数据转发到0.0.0.0：80端口
这样访问外网linux服务器的80端口就相当于访问了内网web服务器的80端口。


### 参考: 

http://blog.csdn.net/a351945755/article/details/21785647

http://www.pchou.info/linux/2015/11/01/ssh-tunnel.html


===========================================实验=====================================================

### # 材料
````
ssh root@10.60.174.65  内网 ip
ssh root@121.201.24.134 外网 ip  10.60.172.239
````

## # 如何建立本地 ssh 隧道?
> 跳板式操作

```
*.65 机器执行
ssh -Nf -L 2121:10.60.172.239:21 10.60.172.239

*.239 机器上面执行
ftp localhost:2121
```
参数:
```
-N 告诉ssh客户端,这个连接不需要执行任何命令

-f 告诉ssh客户端在后台运行

-L 做本地端口映射,被冒号分割的三个部分含义:中间服务器(IP:*.239)
    需要使用的本地端口号
    需要访问的目标机器IP地址(IP: *.65)
    需要访问的目标机器端口(端口:21)
    
-L 参数的行为:  -L X:Y:Z 将Ip为Y的机器的Z端口,通过中间服务器映射到本地的X端口
```

## 如何建立远程ssh隧道

加入是一个内网 10.60.174.65 公司的一台内部服务器,有一台ip为 121.201.24.134(10.60.172.239) 的机器可以访问它,
我们就可以映射 10.60.174.65 的 22 端口到 121.201.24.134(10.60.172.239) 这台机器的 2222 端口
(注意: 10.60.172.239 与 10.60.174.65 需要互相访问)

下面我们通过将 *.65:22 ->  *.239:2222 通过 *.239 的本地2222端口访问内网的 *.65 机器
```
*.65 机器执行
ssh -Nf -R 2222:127.0.0.1:22 10.60.172.239

*.239 机器(外网可以访问的机器)
ssh -p 2222 localhost

-R 参数介绍:
    远程机器使用的端口（2222）
    需要映射的内部机器的IP地址(127.0.0.1)
    需要映射的内部机器的端口(22)

例如：-R X:Y:Z 就是把我们内部的Y机器的Z端口映射到远程机器的X端口上。
```

## ssh 跳过跳板机操作

* 利用 `-o ProxyCommand`

    ssh -o ProxyCommand='ssh -q root@<跳板机> -W %h:%p' root@<目标主机>
    # -W 表示将发送到跳板机的全部操作,转发到目标主机

* 利用 `~/.ssh/config`

    Host ss          
        HostName <跳板机>
        User root 
        Port 22   
    # 利用 nc 进行转发
    #Host 10.0.0.148
    #    User root
    #    ProxyCommand ssh root@<跳板机> nc 10.0.0.148 %p  2>/dev/null  
    Host 10.0.0.148
        HostName 10.0.0.148
        User root 
        Port 22   
        ProxyCommand ssh -q -W %h:%p ss
    Host *           
        Port 22   
        User root 

`10.0.0.148` 为目标主机

`nc <目标主机> port` 发送到跳板机的指令,全部转发到<目标主机>
